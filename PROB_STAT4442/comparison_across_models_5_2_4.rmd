---
title: "Comparison Across Models"
author: "C. Durso"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Best model for "chd"

One goal of this sequence of exercises is to identify the best logistic regression model for "chd" in terms of the explanatory variables in the data and their squares where relevant. Previous pages include code that facilitates identification of the best model from a sequence of models generated by backward selection according to the criterion of minimum validation deviance, along with the best model from a sequence of models generated by forward selection, and a sequence of models generated by best subset selection. The choice among these three models can again be made on the basis of the deviance of the model on the validation set. 

### Data

Read in the data and break it into training, validation, and test sets. Preserve the breakdown used in the analysis of the appropriateness of the train-validate-test protocol for this analysis. 

```{r}
dat<-read.csv("SAheart.data")
# The "dplyr::"" specifies that the dplyr "select" function be used
dat<-dplyr::select(dat, -row.names) 
n<-nrow(dat)
dat$famhist<-(dat$famhist=="Present")*1 # better for bestglm

set.seed(123456)
tvt<-sample(rep(0:2,c(round(n*.2),round(n*.2),n-2*round(n*.2))),n)


dat.train<-dat[tvt==2,]
dat.valid<-dat[tvt==1,]
dat.test<-dat[tvt==0,]
```

### The models

As computed in previous work, the formulas for the best forward model, backward model, and best subsets model are as follows:


```{r}

(fmla.backward.best<-as.formula("chd ~ 1 + age + ldl + famhist + tobacco + I(typea^2) + I(age^2) + 
    I(sbp^2)"))

(fmla.forward.best<-as.formula("chd ~ tobacco + ldl + famhist + obesity + age + I(typea^2)"))

(fmla.best.subset<-as.formula("chd~tobacco+ldl+famhist+age+I(typea^2)+I(age^2)"))
```
Fit models to using each of these formulas.

```{r}
m.backward<-glm(fmla.backward.best,data=dat.train,family="binomial")
m.forward<-glm(fmla.forward.best,data=dat.train,family="binomial")
m.best.subset<-glm(fmla.best.subset,
                    data=dat.train,family="binomial")
```


Implement a deviance function to calculate the deviance of a model on a validation set.

```{r}
valid.dev<-function(m.pred, dat.this){
  pred.m<-predict(m.pred,dat.this, type="response")
-2*sum(dat.this$chd*log(pred.m)+(1-dat.this$chd)*log(1-pred.m))
}
```

Apply it to the each of the models and "dat.valid"

```{r}
devs<-c(valid.dev(m.backward,dat.valid),
        valid.dev(m.forward,dat.valid),
        valid.dev(m.best.subset,dat.valid))

```





