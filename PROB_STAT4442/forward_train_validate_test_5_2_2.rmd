---
title: "Best Forward Selection Model by Validation"
author: "C. Durso"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Best forward model for "chd"

This document does background calculations useful to finding the best model for "chd" by the criterion of having the best deviance on the validation set. The explanatory variables under consideration are the original variables and their squares. 

### Data

Read in the data and break it into training, validation, and test sets. Preserve the breakdown used in the analysis of the appropriateness of the train-validate-test protocol for this analysis. 

```{r}
dat<-read.csv("SAheart.data")
# The "dplyr::"" specifies that the dplyr "select" function be used
dat<-dplyr::select(dat, -row.names) 
n<-nrow(dat)
dat$famhist<-(dat$famhist=="Present")*1 # better for bestglm

set.seed(123456)
tvt<-sample(rep(0:2,c(round(n*.2),round(n*.2),n-2*round(n*.2))),n)


dat.train<-dat[tvt==2,]
dat.valid<-dat[tvt==1,]
dat.test<-dat[tvt==0,]
```

### Construct Full Model Formula

Use string manipulation to construct the formula for "chd" in terms of the original variables and their squares

```{r}
nam<-names(dat.train)[1:(ncol(dat.train)-1)]

# Assemble the names of the numeric variables. The variable
# "famhist" is the only non-numeric variable. Its 
# square should be omitted.
nam.num<-setdiff(nam,"famhist")

# Use stringr to avoid typing all the explanatory variables.
fmla.sq<-as.formula(str_c("chd~",
    str_c(nam,collapse="+"),"+",
    str_c("I(",nam.num,"^2)",
              collapse="+")))
```

## Forward Model

By decreasing the penalty in AIC from $2k-2\ln(Likelihood)$ to 
$0k-2\ln(Likelihood)$, say, we can force the forward selection process to fit a complete sequence of models. In the context in which model selection is by validation error and the number of variables is moderate, a stopping criterion isn't necessary.

```{r }
m<-glm(chd~1,data=dat.train,family ="binomial" )
m.forward<-step(m,scope=fmla.sq,direction="forward",trace=0,k=0)
m.forward$anova
```


Construct formulas for the sequence of models produced by backward selection.

```{r}
# All variables
vars<-c(nam,str_c("I(",nam.num,"^2)"))

# The sequence in which variables are dropped
vars.add<-m.forward$anova[,1]
vars.add<-str_replace(vars.add,"\\+ ","")
vars.add[1]<-1 # Intercept only

# function to removecollect the first "i" variables added during
# forward selection and
# create a formula for "chd" in terms of the remaining
# variables.

fmla.add.fnc<-function(i,vars.add){
  
  # your code here
  
}

# Apply "fmla.add.fnc" to each value of "i". This
# gives the formulas for the models generated by forward
# selection.

fmlas<-apply(matrix(1:length(vars.add),ncol=1),1,
   fmla.add.fnc,vars.add=vars.add)

```

Construct the models on the training data corresponding to this list of formulas.

```{r}
# Use an anonymous function, defined in place.
models<-
  lapply(fmlas,function(x){glm(x,data=dat.train,family="binomial")})

```


Implement a deviance function to calculate the deviance of a model on a validation set.

```{r}
valid.dev<-function(m.pred, dat.this){
  pred.m<-predict(m.pred,dat.this, type="response")
-2*sum(dat.this$chd*log(pred.m)+(1-dat.this$chd)*log(1-pred.m))
}
```

Apply it to the list of models and "dat.valid"

```{r}
dev.valid<-sapply(models,valid.dev,dat.this=dat.valid)
```

Visualize the results.

```{r}
devs<-data.frame(size=#your values here,
validation.deviance=dev.valid)

ggplot(data=devs, aes(x=size,y=validation.deviance))+geom_point()
```




